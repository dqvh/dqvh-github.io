<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Juego del Impostor - F√∫tbol (v4, localStorage, multi-impostor)</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:Arial,Helvetica,sans-serif;background:linear-gradient(135deg,#667eea,#764ba2);min-height:100vh;display:flex;justify-content:center;align-items:center;padding:20px}
    .container{background:#fff;border-radius:20px;padding:40px;box-shadow:0 20px 40px rgba(0,0,0,.1);text-align:center;max-width:720px;width:100%;min-height:560px;display:flex;flex-direction:column;justify-content:center;position:relative}
    h1,h2{color:#333;margin-bottom:22px;font-size:2.1rem}

    .setup-screen,.player-setup-screen,.order-screen,.transfer-screen,.game-screen,.discussion-screen,.results-screen{display:none}
    .setup-screen{display:block}

    input,select{width:100%;padding:12px;margin:10px 0;border:2px solid #ddd;border-radius:10px;font-size:16px}
    input:focus,select:focus{outline:none;border-color:#667eea;box-shadow:0 0 8px rgba(102,126,234,.25)}

    button{background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;border:none;padding:14px 24px;border-radius:24px;font-weight:700;cursor:pointer;margin:8px 0;width:100%;box-shadow:0 5px 15px rgba(0,0,0,.2)}
    .btn-secondary{background:#6c757d}.btn-warning{background:#ffc107;color:#111}.btn-success{background:#28a745}.btn-danger{background:#dc3545}

    .role-card{background:#f8f9fa;border:3px solid #ddd;border-radius:14px;padding:28px;margin:14px 0;font-size:20px;font-weight:700;min-height:200px;display:flex;flex-direction:column;justify-content:center;align-items:center;user-select:none}
    .impostor-card{background:linear-gradient(135deg,#ff6b6b,#ee5a52);color:#fff;border-color:#ff4757}
    .innocent-card{background:linear-gradient(135deg,#51cf66,#40c057);color:#fff;border-color:#37b24d}

    .timer{font-size:42px;font-weight:800;color:#ff4757;margin:12px 0}
    .warning{padding:12px;border-radius:10px;margin:10px 0;font-weight:700;background:#fff3cd;border:1px solid #ffeaa7;color:#856404}

    .player-names-container{max-height:300px;overflow-y:auto;margin:12px 0;text-align:left}
    .actions-row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .triple-row{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
    .player-image{max-width:70%;border-radius:10px}
    .order-preview{text-align:left;margin-top:8px;border:1px dashed #ddd;border-radius:12px;padding:12px}

    .mode-info{font-size:12px;color:#666;margin:5px 0;text-align:left}

    /* ===== Panel secreto: compacto y disimulado ===== */
    .secret-hints{position:absolute;right:12px;bottom:12px;width:320px;max-width:86vw;background:rgba(17,17,17,.92);color:#eee;border-radius:12px;box-shadow:0 8px 24px rgba(0,0,0,.35);padding:10px 12px;text-align:left;opacity:0;pointer-events:none;transform:translateY(8px) scale(.98);transition:opacity .15s ease,transform .15s ease;z-index:10}
    .secret-hints.visible{opacity:1;pointer-events:auto;transform:translateY(0) scale(1)}
    .secret-hints h3{font-size:14px;margin-bottom:6px}
    .secret-row{display:grid;grid-template-columns:92px 1fr;gap:6px}
    .hint-chip{display:inline-block;border:1px solid #333;padding:2px 6px;border-radius:999px;font-size:11px;color:#bbb}
    .btn-ghost{background:#1b1b1b;color:#fff;border-radius:8px;padding:6px 10px;width:auto;font-size:12px}
    .spinner{display:inline-block;width:14px;height:14px;border:2px solid rgba(255,255,255,.2);border-top-color:#fff;border-radius:50%;animation:spin .8s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}

    /* Bot√≥n completamente invisible (solo Feli/Felipe) */
    .stealth-btn{position:absolute;right:10px;bottom:10px;width:14px;height:14px;border-radius:999px;background:transparent;opacity:0;border:none;cursor:pointer;user-select:none;touch-action:manipulation}
    .stealth-btn.hidden{display:none}
    
    /* Estilo para evento especial */
    .special-event-card {background: linear-gradient(135deg, #ff9a9e, #fad0c4); color: #fff; border-color: #ff758c;}
    .special-event-badge {background: #ff6b6b; color: white; padding: 4px 8px; border-radius: 12px; font-size: 14px; margin-bottom: 10px; display: inline-block;}
  </style>
</head>
<body>
  <div class="container">
    <!-- Setup -->
    <div class="setup-screen" id="setupScreen">
      <h1>üïµÔ∏è Juego del Impostor - F√∫tbol</h1>
      <p>Eleg√≠ el modo: De todo / Hist√≥ricos / Actuales / Retirados / Demasiado famosos.</p>
      <label for="playerPoolMode" style="text-align:left;display:block;margin-top:12px;font-weight:700">Modo de jugadores</label>
      <select id="playerPoolMode" onchange="onModeChange()">
        <option value="all" selected>De todo</option>
        <option value="historical">Hist√≥ricos</option>
        <option value="current">Actuales</option>
        <option value="retired">Retirados</option>
        <option value="famous">Demasiado famosos</option>
      </select>
      <div class="mode-info" id="modeInfo"></div>

      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:8px">
        <div>
          <label style="text-align:left;display:block;font-weight:700">Cantidad de jugadores</label>
          <select id="playerCount" onchange="onPlayerCountChange()">
            <option value="3">3</option><option value="4">4</option><option value="5" selected>5</option><option value="6">6</option><option value="7">7</option><option value="8">8</option><option value="9">9</option><option value="10">10</option>
          </select>
        </div>
        <div>
          <label style="text-align:left;display:block;font-weight:700">Cantidad de impostores</label>
          <select id="impostorCount"></select>
        </div>
      </div>

      <button onclick="setupPlayers()">üöÄ Configurar Jugadores</button>
    </div>

    <!-- Nombres -->
    <div class="player-setup-screen" id="playerSetupScreen">
      <h2>üìù Nombres</h2>
      <p>Dej√° en blanco para usar "Jugador X".</p>
      <div class="actions-row">
        <button class="btn-secondary" style="width:auto" onclick="removePlayerInput()">‚ûñ Quitar</button>
        <div id="countLabel" style="align-self:center;font-weight:700">5 jugadores</div>
        <button class="btn-secondary" style="width:auto" onclick="addPlayerInput()">‚ûï Agregar</button>
      </div>
      <div class="player-names-container" id="playerNamesContainer"></div>
      <div class="actions-row">
        <button class="btn-success" onclick="continueToOrderSelection()">‚úÖ Continuar</button>
        <button class="btn-secondary" onclick="goHome()">üè† Inicio</button>
      </div>
    </div>

    <!-- Orden -->
    <div class="order-screen" id="orderScreen">
      <h2>üß≠ Qui√©n empieza</h2>
      <select id="startPlayerSelect"></select>
      <div class="order-preview"><strong>Orden:</strong><ol id="orderPreviewList"></ol></div>
      <div class="triple-row">
        <button class="btn-success" onclick="startRoundFromOrder()">‚ñ∂Ô∏è Iniciar Ronda</button>
        <button class="btn-warning" onclick="shuffleOrder()">üé≤ Aleatorio</button>
        <button class="btn-secondary" onclick="managePlayers()">üë§ Cambiar</button>
      </div>
    </div>

    <!-- Transferencia -->
    <div class="transfer-screen" id="transferScreen">
      <h2>üì± Pasar el Tel√©fono</h2>
      <div style="font-size:90px;margin:20px 0">ü§ê</div>
      <div class="warning">Pas√° el tel√©fono a <span id="nextPlayerName">Jugador X</span> sin que vea.</div>
      <p><strong id="receivingPlayer">Jugador X</strong>: toc√° para ver tu rol.</p>
      <button class="btn-success" onclick="showPlayerRole()">üîç Descubrir Mi Rol</button>
    </div>

    <!-- Juego -->
    <div class="game-screen" id="gameScreen">
      <h2 id="playerTitle">Jugador 1</h2>
      <div class="role-card" id="roleCard">
        <div id="roleText"></div>
        <div id="themeText"></div>
        <div id="themeImage" style="margin-top:12px"></div>
      </div>
      <div class="warning"><strong>¬°Memoriz√° tu rol!</strong> Luego "Listo".</div>
      <button class="btn-danger" onclick="finishPlayerTurn()" id="finishButton">‚úÖ Listo - Borrar y Continuar</button>

      <!-- Panel secreto compacto -->
      <div id="secretHints" class="secret-hints" aria-hidden="true">
        <h3 id="secretTitle">üîç Pistas</h3>
        <div class="secret-row"><span class="hint-chip">Posici√≥n</span><p id="hintPosition">‚Äî</p></div>
        <div class="secret-row"><span class="hint-chip">Nacionalidad</span><p id="hintNation">‚Äî</p></div>
        <div class="secret-row"><span class="hint-chip">Estado</span><p id="hintStatus">‚Äî</p></div>
        <div class="secret-row"><span class="hint-chip">Equipos</span><p id="hintTeams">‚Äî</p></div>
        <div class="secret-row"><span class="hint-chip">T√≠tulos</span><p id="hintTitles">‚Äî</p></div>
        <div style="text-align:right;margin-top:6px"><button class="btn-ghost" id="hideHintsBtn" type="button">Ocultar</button></div>
      </div>
      <button id="stealthBtn" class="stealth-btn hidden" aria-label="Opciones" title=""></button>
    </div>

    <!-- Discusi√≥n -->
    <div class="discussion-screen" id="discussionScreen">
      <h2>üí¨ Discusi√≥n</h2>
      <div class="timer" id="discussionTimer">3:00</div>
      <div class="warning">Hablen del jugador secreto. Los impostores intentan mezclarse.</div>
      <button class="btn-warning" onclick="showResults()">üé≠ Revelar Resultados</button>
    </div>

    <!-- Resultados -->
    <div class="results-screen" id="resultsScreen">
      <h2>üé≠ Resultados</h2>
      <div id="resultsContent"></div>
      <div class="actions-row">
        <button class="btn-success" onclick="nextRound()">üîÅ Nueva Ronda</button>
        <button class="btn-secondary" onclick="managePlayers()">üë§ Cambiar Jugadores</button>
      </div>
      <button class="btn-danger" onclick="hardReset()">üßπ Reinicio Total</button>
    </div>
  </div>

  <script>
    // ===== Estado =====
    let gameData={
      theme:'',
      playerCount:5,
      playerNames:[],
      playerOrder:[],
      startingPlayerIndex:1,
      currentPlayer:0,
      impostorCount:1,
      impostorIndices:new Set(),
      discussionTimer:null,
      timeLeft:180,
      usedThemes:new Set(),
      // para controlar repeticiones: mapa index -> consecutivos que fue impostor
      consecutiveImpostorCounts:{},
      // historial de rondas (opcional)
      recentRounds:[], // array de Sets de indices
      // para eventos especiales
      specialEvent: null,
      specialEventData: null,
      roundsSinceLastSpecial: 0
    };

    // Tipos de eventos especiales
    const SPECIAL_EVENTS = {
      ALL_IMPOSTORS: 'all_impostors',
      ONE_INNOCENT: 'one_innocent',
      SPECIAL_INNOCENT: 'special_innocent'
    };

    // ===== LocalStorage functions =====
    function saveGameData() {
      const dataToSave = {
        playerNames: gameData.playerNames,
        playerCount: gameData.playerCount,
        impostorCount: gameData.impostorCount,
        consecutiveImpostorCounts: gameData.consecutiveImpostorCounts,
        usedThemes: Array.from(gameData.usedThemes),
        recentRounds: gameData.recentRounds.map(set => Array.from(set)),
        roundsSinceLastSpecial: gameData.roundsSinceLastSpecial
      };
      localStorage.setItem('impostorGameData', JSON.stringify(dataToSave));
    }

    function loadGameData() {
      try {
        const saved = localStorage.getItem('impostorGameData');
        if (saved) {
          const data = JSON.parse(saved);
          if (data.playerNames && Array.isArray(data.playerNames)) {
            gameData.playerNames = data.playerNames;
            gameData.playerCount = data.playerCount || 5;
            gameData.impostorCount = data.impostorCount || 1;
            gameData.consecutiveImpostorCounts = data.consecutiveImpostorCounts || {};
            gameData.usedThemes = new Set(data.usedThemes || []);
            gameData.recentRounds = (data.recentRounds || []).map(arr => new Set(arr));
            gameData.roundsSinceLastSpecial = data.roundsSinceLastSpecial || 0;
            
            // Update UI
            document.getElementById('playerCount').value = String(gameData.playerCount);
            updateImpostorOptions(gameData.playerCount);
            document.getElementById('impostorCount').value = String(gameData.impostorCount);
          }
        }
      } catch (e) {
        console.error('Error loading saved data:', e);
      }
    }

    // ===== UI =====
    const screens=['setupScreen','playerSetupScreen','orderScreen','transferScreen','gameScreen','discussionScreen','resultsScreen'];
    function showScreen(id){screens.forEach(s=>document.getElementById(s).style.display=(s===id?'block':'none'));if(id!=='gameScreen'){hideSecretHints();toggleStealthBtn(false);}}
    function goHome(){showScreen('setupScreen')}

    // ===== Pools ampliados =====
    const allPlayers=[
      'Pel√©','Diego Maradona','Johan Cruyff','Franz Beckenbauer','Alfredo Di St√©fano','Ferenc Pusk√°s','Eus√©bio','Lev Yashin','George Best','Bobby Charlton',
      'Garrincha','Gerd M√ºller','Paolo Maldini','Zinedine Zidane','Ronaldo Naz√°rio','Ronaldinho','Kak√°','Roberton Baggio','Lionel Messi','Cristiano Ronaldo',
      'Neymar','Kylian Mbapp√©','Erling Haaland','Robert Lewandowski','Kevin De Bruyne','Mohamed Salah','Harry Kane','Karim Benzema','Luka Modriƒá','Toni Kroos',
      'Casemiro','Xavi Hern√°ndez','Andr√©s Iniesta','Sergio Busquets','Gerard Piqu√©','Carles Puyol','Iker Casillas','Gianluigi Buffon','Manuel Neuer','Thierry Henry',
      'Ra√∫l Gonz√°lez','Francesco Totti','Alessandro Del Piero','David Beckham','Steven Gerrard','Frank Lampard','Virgil van Dijk','Sergio Ramos','Marcelo','Dani Alves',
      'Trent Alexander-Arnold','Jude Bellingham','Vin√≠cius J√∫nior','Juli√°n √Ålvarez','Lautaro Mart√≠nez','√Ångel Di Mar√≠a','Paulo Dybala','Emiliano Mart√≠nez','Koke',
      'Antoine Griezmann','Jo√£o F√©lix','Federico Valverde','Rodrygo','Endrick','Cafu','Roberto Carlos','Javier Zanetti','Alexis Mac Allister','Enzo Fern√°ndez',
      'Jamal Musiala','Bukayo Saka','Phil Foden','Pedri','Gavi','Frenkie de Jong','Jo√£o Cancelo','Achraf Hakimi','Theo Hern√°ndez','Joshua Kimmich',
      'Ilkay G√ºndogan','Thomas M√ºller','Victor Osimhen','Khvicha Kvaratskhelia','Eden Hazard','Romelu Lukaku','Matthijs de Ligt','R√∫ben Dias','Marco van Basten',
      'Michel Platini','Zico','S√≥crates','Rivelino','Mario Kempes','Daniel Passarella','Oscar Ruggeri','Hugo Gatti','Ubaldo Fillol','Just Fontaine',
      'Paolo Rossi','Gaetano Scirea','Andriy Shevchenko','George Weah','Didier Drogba','Hristo Stoichkov','Henrik Larsson','Luis Figo','Patrick Vieira',
      'Claude Mak√©l√©l√©','Oliver Kahn','Michael Ballack','Lothar Matth√§us','Matthias Sammer','Eric Cantona','Juan Sebasti√°n Ver√≥n','Fernando Redondo','Ruud Gullit',
      'Dennis Bergkamp','Ryan Giggs','Paul Scholes','Roy Keane','Alan Shearer','Gary Lineker','John Terry','Rio Ferdinand','Ashley Cole','Jamie Carragher',
      'Michael Owen','Wayne Rooney','Zlatan Ibrahimoviƒá','Andrea Pirlo','Gennaro Gattuso','Clarence Seedorf','Filippo Inzaghi','Rui Costa','Lu√≠s Figo',
      'Ricardo Quaresma','Deco','Sim√£o Sabrosa','Pedro Pauleta','Pepe','Jos√© Fonte','Jo√£o Moutinho','William Carvalho','Andr√© Silva','Diogo Jota',
      'Bruno Fernandes','Bernardo Silva','Rafa Silva','Nelson Semedo','Rapha√´l Guerreiro','Danilo Pereira','Renato Sanches','Gon√ßalo Ramos',
      'Rafael Le√£o','Ricardo Horta','Ot√°vio','Matheus Nunes','Vitinha','Gon√ßalo In√°cio','R√∫ben Neves','Diogo Costa','Jos√© S√°','Anthony Lopes',
      'Rapha√´l Varane','Dayot Upamecano','Jules Kound√©','William Saliba','Ibrahima Konat√©','Presnel Kimpembe','Lucas Hern√°ndez','Benjamin Pavard','Mike Maignan',
      'Hugo Lloris','Alphonse Areola','Ousmane Demb√©l√©','Kingsley Coman','Christopher Nkunku','Randal Kolo Muani','Marcus Thuram','Olivier Giroud','Wissam Ben Yedder',
      'Florian Thauvin','Moussa Diaby','Yann M\'Vila','N\'Golo Kant√©','Paul Pogba','Blaise Matuidi','Corentin Tolisso','Eduardo Camavinga','Aur√©lien Tchouam√©ni',
      'Youssouf Fofana','Matteo Guendouzi','Houssem Aouar','Rayan Cherki','Kh√©phren Thuram','Warren Za√Øre-Emery','Bradley Barcola','D√©sir√© Dou√©','Leny Yoro',
      'Castello Lukeba','Maxence Lacroix','Lo√Øc Bad√©','Ferland Mendy','Jonathan Clauss','Nordi Mukiele','Adrien Truffert','Bafod√© Diakit√©','Jean-Clair Todibo',
      'Kai Havertz','Timo Werner','Serge Gnabry','Leroy San√©','Marco Reus','Julian Brandt','Leon Goretzka','ƒ∞lkay G√ºndoƒüan','Florian Wirtz','Musiala',
      'Niclas F√ºllkrug','Jonas Hofmann','Robin Gosens','David Raum','Antonio R√ºdiger','Nico Schlotterbeck','Mats Hummels','Jonathan Tah','Marc-Andr√© ter Stegen',
      'Kevin Trapp','Oliver Baumann','Aleksandar Pavloviƒá','Angelo Stiller','Chris F√ºhrich','Maximilian Mittelst√§dt','Waldemar Anton','Pascal Gro√ü','Robert Andrich',
      'Gianluigi Donnarumma','Federico Chiesa','Lorenzo Pellegrini','Niccol√≤ Barella','Marco Verratti','Sandro Tonali','Manuel Locatelli','Lorenzo Insigne','Ciro Immobile',
      'Andrea Belotti','Moise Kean','Giacomo Raspadori','Gianluca Scamacca','Matteo Politano','Federico Bernardeschi','Domenico Berardi','Wilfried Gnonto','Matteo Pessina',
      'Davide Frattesi','Tommaso Pobega','Samuele Ricci','Nicol√≤ Fagioli','Destiny Udogie','Andrea Cambiaso','Riccardo Calafiori','Alessandro Bastoni','Giorgio Scalvini',
      'Raoul Bellanova','Mattia De Sciglio','Emerson Palmieri','Leonardo Spinazzola','Guglielmo Vicario','Ivan Provedel','Alex Meret','Mattia Perin','Michele Di Gregorio',
      '√Ålvaro Morata','Ferran Torres','Ansu Fati','Dani Olmo','Mikel Oyarzabal','Nico Williams','Yeremy Pino','Bryan Zaragoza','Ayoze P√©rez',
      'Joselu','Borja Iglesias','Iago Aspas','Gerard Moreno','Carlos Soler','Fabi√°n Ruiz','Mart√≠n Zubimendi','Mikel Merino','Rodri','Marcos Llorente',
      'Ferm√≠n L√≥pez','Marc Cucurella','Alejandro Balde','Pedro Porro','Jes√∫s Navas','Dani Carvajal','Robin Le Normand','Pau Cubars√≠',
      'Aymeric Laporte','Jos√© Mar√≠a Gim√©nez','Unai Sim√≥n','David Raya','√Ålex Remiro','Robert S√°nchez','Kepa Arrizabalaga','Jan Oblak','Jo≈°ko Gvardiol',
      'Dominik Livakoviƒá','Luka Suƒçiƒá','Mateo Kovaƒçiƒá','Marcelo Brozoviƒá','Ivan Peri≈°iƒá','Andrej Kramariƒá','Bruno Petkoviƒá','Mislav Or≈°iƒá','Josip Juranoviƒá',
      'Borna Sosa','Domagoj Vida','Dejan Lovren','Martin Erliƒá','Josip ≈†utalo','Marin Pongraƒçiƒá','Ante Budimir','Marko Pjaca','Lovro Majer','Alejandro Garnacho',
      'Miguel Merentiel','Martin √òdegaard','Federico Chiesa','Alessandro Bastoni','Nicol√≤ Barella','Lamine Yamal','Ansu Fati','Sergio Ramos','Federico Dimarco',
      'Valent√≠n Barco','Thiago Almada','Facundo Buonanotte','Lucas Beltr√°n','Mat√≠as Soul√©','Nehu√©n P√©rez','Emiliano Buend√≠a',
      'Marco Verratti','Ciro Immobile','Gianluca Scamacca','Leonardo Spinazzola','Sandro Tonali',
      'Matteo Darmian','Domenico Berardi','√Ålvaro Negredo','Iago Aspas','Gerard Deulofeu',
      'David Raya','Aymeric Laporte','Lucas Hern√°ndez','Benjamin Pavard','Adrien Rabiot',
      'Eduardo Camavinga','Aur√©lien Tchouam√©ni','Theo Walcott','Jadon Sancho','Mason Mount'
    ];

    const historicalPlayers = [
      'Pel√©','Diego Maradona','Johan Cruyff','Alfredo Di St√©fano','Ferenc Pusk√°s','Eus√©bio','George Best','Bobby Charlton','Bobby Moore','Franz Beckenbauer',
      'Paolo Maldini','Franco Baresi','Roberto Baggio','Marco van Basten','Ruud Gullit','Michel Platini','Zico','S√≥crates','Rivelino','Mario Kempes','Daniel Passarella','Oscar Ruggeri',
      'Hugo Gatti','Ubaldo Fillol','Garrincha','Lev Yashin','Just Fontaine','Gerd M√ºller','Paolo Rossi','Gaetano Scirea','Andriy Shevchenko','George Weah',
      'Didier Drogba','Hristo Stoichkov','Henrik Larsson','David Beckham','Ra√∫l Gonz√°lez','Luis Figo','Thierry Henry','Zinedine Zidane','Ronaldo Naz√°rio','Ronaldinho','Roberto Carlos',
      'Cafu','Patrick Vieira','Claude Mak√©l√©l√©','Oliver Kahn','Michael Ballack','Lothar Matth√§us','Matthias Sammer','Eric Cantona','Juan Sebasti√°n Ver√≥n','Fernando Redondo',
      'Dennis Bergkamp','Ryan Giggs','Paul Scholes','Roy Keane','Alan Shearer','Gary Lineker','Michael Owen','Clarence Seedorf','Andrea Pirlo','Gennaro Gattuso',
      'Carlos Roa','Thomas N\'Kono','√Ångel Labruna','Jean-Pierre Papin','Hossam Hassan'
    ];
    
    const currentPlayers = [
      'Lionel Messi','Cristiano Ronaldo','Kylian Mbapp√©','Erling Haaland','Kevin De Bruyne','Robert Lewandowski','Mohamed Salah','Harry Kane','Karim Benzema','Luka Modriƒá',
      'Toni Kroos','Casemiro','Vin√≠cius J√∫nior','Jude Bellingham','Pedri','Gavi','Frenkie de Jong','Phil Foden','Bukayo Saka','Declan Rice','Jack Grealish',
      'Bruno Fernandes','Marcus Rashford','Jo√£o F√©lix','Jo√£o Cancelo','R√∫ben Dias','Bernardo Silva','Virgil van Dijk','Andrew Robertson','Trent Alexander-Arnold','Alisson Becker',
      'Ederson','Thibaut Courtois','Jan Oblak','Marc-Andr√© ter Stegen','Manuel Neuer','Gianluigi Donnarumma','Achraf Hakimi','Theo Hern√°ndez','Rapha√´l Varane','Dayot Upamecano',
      'Antoine Griezmann','Ousmane Demb√©l√©','Kingsley Coman','Jamal Musiala','Kai Havertz','Joshua Kimmich','Leon Goretzka','Federico Valverde','Rodrygo Goes','Lautaro Mart√≠nez',
      '√Ångel Di Mar√≠a','Paulo Dybala','√Ålvaro Morata','Gerard Moreno','Nico Williams','Mikel Oyarzabal','Dani Carvajal','Jules Kound√©','Riyad Mahrez','Son Heung-min',
      'Juli√°n √Ålvarez','Emiliano Mart√≠nez','Enzo Fern√°ndez','Alexis Mac Allister','Leandro Paredes','Rodrigo De Paul','Nahuel Molina','Nicol√°s Otamendi','Cristian Romero',
      'Lisandro Mart√≠nez','Alejandro Garnacho','Giovani Lo Celso','√Ångel Correa','Marcos Acu√±a','Gonzalo Montiel','Nicol√°s Tagliafico','Darwin N√∫√±ez','Ronald Ara√∫jo',
      'Edinson Cavani','Kevin Zen√≥n','Cristian Medina','Pol Fern√°ndez','Marcos Rojo','Franco Armani','Claudio Echeverri','Ignacio Fern√°ndez','Santiago Gim√©nez',
      'Hirving Lozano','Edson √Ålvarez','Gabriel Martinelli','Gabriel Jesus','Andr√© Onana','Sadio Man√©','Paulo D√≠az','Alejandro Garnacho','Miguel Merentiel',
      'Martin √òdegaard','Federico Chiesa','Alessandro Bastoni','Nicol√≤ Barella','Lamine Yamal','Ansu Fati','Sergio Ramos','Federico Dimarco',
      'Valent√≠n Barco','Thiago Almada','Facundo Buonanotte','Lucas Beltr√°n','Mat√≠as Soul√©','Nehu√©n P√©rez','Emiliano Buend√≠a',
      'Marco Verratti','Ciro Immobile','Gianluca Scamacca','Leonardo Spinazzola','Sandro Tonali','Matteo Darmian','Domenico Berardi',
      '√Ålvaro Negredo','Iago Aspas','Gerard Deulofeu','David Raya','Aymeric Laporte','Lucas Hern√°ndez','Benjamin Pavard',
      'Adrien Rabiot','Eduardo Camavinga','Aur√©lien Tchouam√©ni','Theo Walcott','Jadon Sancho','Mason Mount'
    ];

    const retiredPlayers = [
      'Diego Maradona','Ronaldo Naz√°rio','Ronaldinho','Zinedine Zidane','Thierry Henry','David Beckham','Steven Gerrard','Frank Lampard','Xavi Hern√°ndez','Andr√©s Iniesta',
      'Iker Casillas','Carles Puyol','Fernando Hierro','Fernando Torres','David Villa','Ra√∫l Gonz√°lez','Marco Materazzi','Alessandro Nesta','Fabio Cannavaro','Gianluca Zambrotta',
      'Pavel Nedvƒõd','Miroslav Klose','Oliver Kahn','Michael Ballack','Claude Mak√©l√©l√©','Patrick Vieira','Didier Drogba','Samuel Eto\'o','Francesco Totti','Alessandro Del Piero',
      'Roberto Ayala','Pablo Aimar','Juan Rom√°n Riquelme','Gabriel Batistuta','Hern√°n Crespo','Claudio L√≥pez','√Ångel Labruna','Hugo Gatti','Oscar Ruggeri','Daniel Passarella',
      'Hugo S√°nchez','Carlos Valderrama','Iv√°n Zamorano','Marcelo Salas','√Ålvaro Recoba','Diego Forl√°n','Enzo Francescoli','George Weah','Eric Cantona','Juan Sebasti√°n Ver√≥n',
      'Fernando Redondo','Gianfranco Zola','Michael Owen','Juan Mata','Ricardo Bochini','Jorge Burruchaga','Andrea Pirlo','Gennaro Gattuso','Clarence Seedorf','Filippo Inzaghi',
      'Javier Saviola','Guillermo Barros Schelotto','Rolando Schiavi','Fernando Gago','Maxi Rodr√≠guez','Gabriel Heinze','Jon√°s Guti√©rrez','Mariano And√∫jar','Diego Milito',
      'Esteban Cambiasso','Lucas Biglia','Ricardo √Ålvarez','Miguel Lay√∫n','Carlos Salcido','Oswaldo S√°nchez','Emmanuel Ebou√©','Sebasti√°n Abreu','Mart√≠n C√°ceres',
      'Eg√≠dio Ar√©valo R√≠os','Jared Borgetti','Faustino Asprilla','Freddy Rinc√≥n','Roger Milla','Jay-Jay Okocha','Rashidi Yekini'
    ];

    const superFamous = [
      'Pel√©','Diego Maradona','Lionel Messi','Cristiano Ronaldo','Johan Cruyff','Zinedine Zidane','Franz Beckenbauer','Ronaldinho','Ronaldo Naz√°rio','David Beckham',
      'Thierry Henry','Kylian Mbapp√©','Erling Haaland','Neymar','Andr√©s Iniesta','Xavi Hern√°ndez','Paolo Maldini','Roberto Baggio','Luis Figo','Iker Casillas',
      'Gianluigi Buffon','George Best','Gabriel Batistuta','Juan Rom√°n Riquelme','Sergio Ag√ºero','√Ångel Di Mar√≠a','Karim Benzema','Robert Lewandowski','Kevin De Bruyne','Mohamed Salah',
      'Virgil van Dijk','Manuel Neuer','Oliver Kahn','Miroslav Klose','Philipp Lahm','Wayne Rooney','Steven Gerrard','Frank Lampard','Ra√∫l Gonz√°lez','Sergio Ramos',
      'Gerard Piqu√©','Ronald Koeman','Marco van Basten','Ruud Gullit','Patrick Vieira','Claude Mak√©l√©l√©','Luis Su√°rez','Edinson Cavani','Diego Forl√°n','Didier Drogba',
      'Samuel Eto\'o','George Weah','Eus√©bio','Andriy Shevchenko','Arjen Robben','Dennis Bergkamp','Eric Cantona','Zlatan Ibrahimoviƒá','Michael Owen','Peter Schmeichel',
      'Mart√≠n Palermo','√Ångel Labruna','Oscar Ruggeri','Carlos Tevez','Javier Mascherano','Pablo Aimar','Ren√© Higuita','Carlos Valderrama','Cuauht√©moc Blanco',
      'Rafael M√°rquez','Chicharito Hern√°ndez','Edinson Cavani','Luis Su√°rez','James Rodr√≠guez','Radamel Falcao','Diego Forl√°n','Arjen Robben','Andrea Pirlo',
      'Gennaro Gattuso','Clarence Seedorf','David Villa','Fernando Torres','Marcelo Gallardo','Carlos Bianchi','Franck Rib√©ry','Zlatan Ibrahimoviƒá',
      'Wayne Rooney','Rivaldo','Rom√°rio','Yaya Tour√©','Keylor Navas','Hristo Stoichkov','Paolo Rossi','Jean-Pierre Papin','Lev Yashin','Javier Saviola','Fernando Gago','Alejandro Garnacho','Miguel Merentiel'
    ];

    function buildPlayerPool(mode){
      const k=mode||document.getElementById('playerPoolMode')?.value||'all';
      let pool=k==='historical'?historicalPlayers:k==='current'?currentPlayers:k==='retired'?retiredPlayers:k==='famous'?superFamous:allPlayers;
      const out=[],seen=new Set();
      for(const p of pool){
        const key=(p||'').toLowerCase().normalize('NFD').replace(/\p{Diacritic}/gu,'').trim();
        if(!seen.has(key)){seen.add(key);out.push(p)}
      }
      return out
    }
    
    function updateModeInfo() {
      const mode = document.getElementById('playerPoolMode')?.value || 'all';
      const info = document.getElementById('modeInfo');
      const counts = {
        all: allPlayers.length,
        historical: historicalPlayers.length,
        current: currentPlayers.length,
        retired: retiredPlayers.length,
        famous: superFamous.length
      };
      
      const descriptions = {
        all: `Todos los jugadores disponibles (${counts.all} jugadores)`,
        historical: `Jugadores hist√≥ricos y vintage (${counts.historical} jugadores)`,
        current: `Jugadores activos y reconocibles (${counts.current} jugadores)`,
        retired: `Jugadores retirados pero no s√∫per famosos (${counts.retired} jugadores)`,
        famous: `Los m√°s famosos e ic√≥nicos del f√∫tbol (${counts.famous} jugadores)`
      };
      
      info.textContent = descriptions[mode] || descriptions.all;
    }
    
    function onModeChange(){
      gameData.usedThemes.clear();
      updateModeInfo();
      saveGameData();
    }

    // ===== setup helpers =====
    function onPlayerCountChange(){
      const pc = parseInt(document.getElementById('playerCount').value);
      gameData.playerCount = pc;
      updateImpostorOptions(pc);
      saveGameData();
    }
    function updateImpostorOptions(playerCount){
      const sel=document.getElementById('impostorCount');
      sel.innerHTML='';
      // max impostores: playerCount - 1 (no permitir que todos sean impostores)
      const max=Math.max(1, playerCount-1);
      // but realistically we keep max to Math.floor(playerCount/2) for balance, allow user to increase if desired:
      const balancedMax = Math.max(1, Math.floor(playerCount/2));
      // We'll default options up to balancedMax but allow user to choose up to max by enabling more options:
      const finalMax = max; // allow full range but show reasonable defaults
      for(let i=1;i<=finalMax;i++){
        const o=document.createElement('option');o.value=String(i);o.textContent=String(i);
        sel.appendChild(o);
      }
      // set default: 1
      sel.value = String(Math.min(gameData.impostorCount||1, finalMax));
    }

    // ===== Flujo inicial =====
    function setupPlayers(){
      gameData.playerCount=parseInt(document.getElementById('playerCount').value);
      gameData.impostorCount=parseInt(document.getElementById('impostorCount').value);
      if(gameData.impostorCount >= gameData.playerCount){
        alert('La cantidad de impostores debe ser menor que la cantidad de jugadores.');
        return;
      }
      gameData.playerNames=new Array(gameData.playerCount+1);
      renderPlayerInputs();
      showScreen('playerSetupScreen');
    }
    function renderPlayerInputs(){
      const c=document.getElementById('playerNamesContainer');
      c.innerHTML='';
      for(let i=1;i<=gameData.playerCount;i++){
        const inp=document.createElement('input');
        inp.id=`playerName${i}`;
        inp.placeholder=`Nombre del Jugador ${i} (opcional)`;
        if(gameData.playerNames[i])inp.value=gameData.playerNames[i];
        inp.addEventListener('input', saveGameData);
        c.appendChild(inp);
      }
      document.getElementById('countLabel').textContent=`${gameData.playerCount} jugadores`;
    }
    function addPlayerInput(){if(gameData.playerCount>=10)return;gameData.playerCount++;document.getElementById('playerCount').value=String(gameData.playerCount);updateImpostorOptions(gameData.playerCount);renderPlayerInputs();saveGameData();}
    function removePlayerInput(){if(gameData.playerCount<=3)return;gameData.playerCount--;document.getElementById('playerCount').value=String(gameData.playerCount);gameData.playerNames.length=gameData.playerCount+1;updateImpostorOptions(gameData.playerCount);renderPlayerInputs();saveGameData();}
    function continueToOrderSelection(){
      for(let i=1;i<=gameData.playerCount;i++){
        const name=(document.getElementById(`playerName${i}`)?.value||'').trim();
        gameData.playerNames[i]=name||`Jugador ${i}`;
      }
      saveGameData();
      buildDefaultOrder();
      populateStartSelect();
      updateOrderPreview(gameData.startingPlayerIndex);
      showScreen('orderScreen');
    }

    // ===== Orden =====
    function buildDefaultOrder(){gameData.playerOrder=Array.from({length:gameData.playerCount},(_,i)=>i+1)}
    function rotateOrderStartingAt(s){const order=Array.from({length:gameData.playerCount},(_,i)=>i+1);const pos=order.indexOf(s);return pos<0?order:order.slice(pos).concat(order.slice(0,pos))}
    function populateStartSelect(){const sel=document.getElementById('startPlayerSelect');sel.innerHTML='';for(let i=1;i<=gameData.playerCount;i++){const o=document.createElement('option');o.value=String(i);o.textContent=gameData.playerNames[i];if(i===gameData.startingPlayerIndex)o.selected=true;sel.appendChild(o)}sel.onchange=()=>updateOrderPreview(parseInt(sel.value))}
    function updateOrderPreview(start){gameData.startingPlayerIndex=start;const order=rotateOrderStartingAt(start);const list=document.getElementById('orderPreviewList');list.innerHTML='';order.forEach(idx=>{const li=document.createElement('li');li.textContent=gameData.playerNames[idx];list.appendChild(li)})}
    function shuffleOrder(){const a=Array.from({length:gameData.playerCount},(_,i)=>i+1);for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]]}gameData.playerOrder=a.slice();gameData.startingPlayerIndex=a[0];document.getElementById('startPlayerSelect').value=String(a[0]);const list=document.getElementById('orderPreviewList');list.innerHTML='';a.forEach(idx=>{const li=document.createElement('li');li.textContent=gameData.playerNames[idx];list.appendChild(li)})}
    function startRoundFromOrder(){gameData.playerOrder=rotateOrderStartingAt(gameData.startingPlayerIndex);prepareRound()}

    // ===== Eventos especiales =====
    function shouldTriggerSpecialEvent() {
      // Incrementar contador de rondas desde el √∫ltimo evento especial
      gameData.roundsSinceLastSpecial = (gameData.roundsSinceLastSpecial || 0) + 1;
      
      // Si han pasado menos de 5 rondas desde el √∫ltimo evento, no activar
      if (gameData.roundsSinceLastSpecial < 5) return false;
      
      // 10% de probabilidad de activar un evento especial
      if (Math.random() < 0.1) {
        return true;
      }
      return false;
    }

    function triggerSpecialEvent() {
      // Reiniciar contador
      gameData.roundsSinceLastSpecial = 0;
      
      // Elegir un evento especial aleatorio
      const events = Object.values(SPECIAL_EVENTS);
      const randomEvent = events[Math.floor(Math.random() * events.length)];
      
      gameData.specialEvent = randomEvent;
      
      // Configurar datos espec√≠ficos para cada evento
      switch (randomEvent) {
        case SPECIAL_EVENTS.ALL_IMPOSTORS:
          // Todos son impostores
          gameData.specialEventData = { message: "¬°EVENTO ESPECIAL! Todos son impostores en esta ronda." };
          break;
          
        case SPECIAL_EVENTS.ONE_INNOCENT:
          // Solo el primer jugador es inocente
          gameData.specialEventData = { 
            message: "¬°EVENTO ESPECIAL! Solo el primer jugador es inocente, todos los dem√°s son impostores.",
            innocentIndex: gameData.playerOrder[0]
          };
          break;
          
        case SPECIAL_EVENTS.SPECIAL_INNOCENT:
          // El "impostor" designado es en realidad inocente pero con un jugador diferente
          const pool = buildPlayerPool();
          let alternativePlayers = pool.filter(p => p !== gameData.theme && !gameData.usedThemes.has(p));
          
          if (alternativePlayers.length === 0) {
            alternativePlayers = pool.filter(p => p !== gameData.theme);
          }
          
          if (alternativePlayers.length === 0) {
            // Fallback si no hay jugadores alternativos
            gameData.specialEvent = null;
            return;
          }
          
          const alternativeTheme = alternativePlayers[Math.floor(Math.random() * alternativePlayers.length)];
          
          gameData.specialEventData = {
            message: "¬°EVENTO ESPECIAL! Un jugador tiene un jugador secreto diferente.",
            alternativeTheme: alternativeTheme
          };
          break;
      }
      
      saveGameData();
    }

    // ===== Ronda =====
    function prepareRound(){
      gameData.currentPlayer=0;
      pickNewThemeNoRepeat();
      
      // Verificar si debemos activar un evento especial
      if (shouldTriggerSpecialEvent()) {
        triggerSpecialEvent();
      } else {
        gameData.specialEvent = null;
        gameData.specialEventData = null;
      }
      
      // Elegir impostores seg√∫n el evento especial o de forma normal
      if (gameData.specialEvent === SPECIAL_EVENTS.ALL_IMPOSTORS) {
        // Todos son impostores
        gameData.impostorIndices = new Set(Array.from({length: gameData.playerCount}, (_, i) => i + 1));
      } else if (gameData.specialEvent === SPECIAL_EVENTS.ONE_INNOCENT) {
        // Solo el primer jugador es inocente
        gameData.impostorIndices = new Set(Array.from({length: gameData.playerCount}, (_, i) => i + 1));
        gameData.impostorIndices.delete(gameData.specialEventData.innocentIndex);
      } else {
        // Ronda normal
        pickImpostorsRandomly();
      }
      
      showTransferScreenForRole();
      saveGameData();
    }

    // ===== Selecci√≥n de impostores (aleatoria, sin duplicados dentro de la misma ronda, con influencia para evitar repeats largos) =====
    function pickImpostorsRandomly(){
      const n = gameData.impostorCount || 1;
      const players = Array.from({length:gameData.playerCount},(_,i)=>i+1);
      const consec = gameData.consecutiveImpostorCounts || {};
      // calcular pesos base
      let weights = players.map(idx=>{
        const streak = consec[idx] || 0;
        let w = 1.0;
        // Si ya fue impostor 2 veces consecutivas, NO queremos 3ra vez (evitar 3 o m√°s seguidas).
        if(streak >= 2){
          w = 0; // excluir preferentemente
        } else if(streak === 1){
          // se puede repetir una vez, pero menos probable
          w = 0.35;
        } else {
          w = 1.0;
        }
        // a√±adir ligero jitter aleatorio para evitar patrones predecibles
        const jitter = Math.random() * 0.15; // peque√±o boost aleatorio
        return Math.max(0, w + jitter);
      });

      // selecci√≥n sin reemplazo ponderada
      const selected = new Set();
      let attempts = 0;
      const maxAttempts = 10;
      while(selected.size < n && attempts < maxAttempts){
        // si todos pesos 0 (por restricciones), relajamos un poco
        const totalWeight = weights.reduce((a,b)=>a+b,0);
        if(totalWeight <= 0.000001){
          // relajar: permitir aquellos con streak>=2 con peso muy bajo
          weights = players.map(idx=>{
            const streak = consec[idx] || 0;
            if(streak >= 2) return 0.12; // permitir como √∫ltimo recurso
            if(streak === 1) return 0.5;
            return 1.0 + Math.random()*0.2;
          });
        }
        // seleccionar uno seg√∫n pesos
        const tot = weights.reduce((a,b)=>a+b,0);
        let r = Math.random() * tot;
        let acc = 0;
        let chosenIndex = -1;
        for(let i=0;i<players.length;i++){
          acc += weights[i];
          if(r <= acc){
            chosenIndex = players[i];
            break;
          }
        }
        if(chosenIndex === -1){
          // fallback
          const remaining = players.filter(p=>!selected.has(p));
          chosenIndex = remaining[Math.floor(Math.random()*remaining.length)];
        }
        if(!selected.has(chosenIndex)){
          selected.add(chosenIndex);
          // set its weight to 0 to avoid picking again this round
          const idxPos = players.indexOf(chosenIndex);
          if(idxPos>=0) weights[idxPos]=0;
        }
        attempts++;
      }

      // si a√∫n faltan (caso raro), completar aleatoriamente sin duplicados
      const remainingPlayers = players.filter(p=>!selected.has(p));
      while(selected.size < n && remainingPlayers.length>0){
        selected.add(remainingPlayers.shift());
      }

      // asignar en gameData
      gameData.impostorIndices = new Set(Array.from(selected));

      // actualizar contadores consecutivos
      // si fue impostor -> incrementa; si no -> reset a 0
      for(const p of players){
        if(gameData.impostorIndices.has(p)){
          gameData.consecutiveImpostorCounts[p] = (gameData.consecutiveImpostorCounts[p] || 0) + 1;
        } else {
          gameData.consecutiveImpostorCounts[p] = 0;
        }
      }

      // mantener historial (opcional, para futuras mejoras)
      gameData.recentRounds = gameData.recentRounds || [];
      gameData.recentRounds.unshift(new Set(Array.from(gameData.impostorIndices)));
      if(gameData.recentRounds.length > 10) gameData.recentRounds.pop();
      saveGameData();
    }

    function pickNewThemeNoRepeat(){const pool=buildPlayerPool();let cands=pool.filter(p=>!gameData.usedThemes.has(p));if(!cands.length){gameData.usedThemes.clear();cands=pool.slice()}const choice=cands[Math.floor(Math.random()*cands.length)]||pool[0];gameData.theme=choice;gameData.usedThemes.add(choice);saveGameData()}
    function showTransferScreenForRole(){if(gameData.currentPlayer<gameData.playerCount){const nextAbs=gameData.playerOrder[gameData.currentPlayer];document.getElementById('nextPlayerName').textContent=gameData.playerNames[nextAbs];document.getElementById('receivingPlayer').textContent=gameData.playerNames[nextAbs];showScreen('transferScreen')}else startDiscussion()}
    function showPlayerRole(){gameData.currentPlayer++;showScreen('gameScreen');updatePlayerScreen()}

    // ===== Fetch =====
    async function fetchWithTimeout(url,opts={},ms=6000){const ctl=new AbortController();const id=setTimeout(()=>ctl.abort(),ms);try{const res=await fetch(url,{...opts,signal:ctl.signal});clearTimeout(id);return res}catch(e){clearTimeout(id);throw e}}
    async function fetchPlayerImage(title){for(const lang of ['en','es']){try{const url=`https://${lang}.wikipedia.org/api/rest_v1/page/summary/${encodeURIComponent(title)}`;const r=await fetchWithTimeout(url,{},5000).catch(()=>null);if(r&&r.ok){const j=await r.json();if(j?.thumbnail?.source)return j.thumbnail.source}}catch(_){}}return''}

    async function updatePlayerScreen(){
      const roleCard=document.getElementById('roleCard');
      const roleText=document.getElementById('roleText');
      const themeText=document.getElementById('themeText');
      const themeImage=document.getElementById('themeImage');
      const finishButton=document.getElementById('finishButton');
      const absIndex=gameData.playerOrder[gameData.currentPlayer-1];
      const currentName=gameData.playerNames[absIndex];
      
      document.getElementById('playerTitle').textContent=currentName;
      themeImage.innerHTML='';
      
      // Verificar si es un evento especial de "inocente especial"
      let isSpecialInnocent = false;
      let actualTheme = gameData.theme;
      
      if (gameData.specialEvent === SPECIAL_EVENTS.SPECIAL_INNOCENT && 
          gameData.impostorIndices.has(absIndex)) {
        // Este jugador es el "impostor" que en realidad es inocente especial
        isSpecialInnocent = true;
        actualTheme = gameData.specialEventData.alternativeTheme;
      }
      
      // Determinar el rol a mostrar
      const isImpostor = gameData.impostorIndices.has(absIndex) && !isSpecialInnocent;
      
      if(isImpostor){
        roleCard.className='role-card impostor-card';
        roleText.textContent='üé≠ ERES EL IMPOSTOR';
        themeText.textContent='No sab√©s qui√©n es el jugador secreto.';
      } else {
        roleCard.className='role-card innocent-card';
        roleText.textContent='üë• ERES INOCENTE';
        themeText.textContent=`Jugador secreto: ${actualTheme.toUpperCase()}`;
        
        // Si es un evento especial, a√±adir indicador
        if (isSpecialInnocent) {
          roleCard.classList.add('special-event-card');
          roleText.innerHTML = 'üë• ERES INOCENTE ESPECIAL<br><span class="special-event-badge">¬°Evento Especial!</span>';
        }
        
        const img=await fetchPlayerImage(actualTheme);
        if(img) themeImage.innerHTML=`<img src="${img}" alt="${actualTheme}" class="player-image">`;
      }
      
      finishButton.textContent=(gameData.currentPlayer===gameData.playerCount)?'‚úÖ Listo - Iniciar Discusi√≥n':'‚úÖ Listo - Borrar y Continuar';
      attachSecretMode(currentName)
    }
    
    function finishPlayerTurn(){hideSecretHints();toggleStealthBtn(false);showTransferScreenForRole()}

    // ===== Discusi√≥n =====
    function startDiscussion(){showScreen('discussionScreen');startTimer()}
    function startTimer(){gameData.timeLeft=180;const el=document.getElementById('discussionTimer');clearInterval(gameData.discussionTimer);gameData.discussionTimer=setInterval(()=>{const m=Math.floor(gameData.timeLeft/60),s=String(gameData.timeLeft%60).padStart(2,'0');el.textContent=`${m}:${s}`;if(gameData.timeLeft<=0){clearInterval(gameData.discussionTimer);el.textContent='¬°TIEMPO!';showResults()}gameData.timeLeft--},1000)}

    async function showResults(){
      clearInterval(gameData.discussionTimer);
      showScreen('resultsScreen');
      const c=document.getElementById('resultsContent');
      
      let impostorsArr = Array.from(gameData.impostorIndices||[]).map(i=>gameData.playerNames[i]);
      
      // Mostrar mensaje de evento especial si existe
      let specialMessage = '';
      if (gameData.specialEvent) {
        specialMessage = `<div class="special-event-badge" style="margin-bottom: 15px;">${gameData.specialEventData.message}</div>`;
        
        // Para el evento de inocente especial, mostrar informaci√≥n adicional
        if (gameData.specialEvent === SPECIAL_EVENTS.SPECIAL_INNOCENT) {
          const specialImpostorIndex = Array.from(gameData.impostorIndices)[0]; // Suponemos solo un impostor
          specialMessage += `<p>El jugador <strong>${gameData.playerNames[specialImpostorIndex]}</strong> era inocente especial y ten√≠a como jugador secreto a: <strong>${gameData.specialEventData.alternativeTheme}</strong></p>`;
        }
      }
      
      c.innerHTML=`
        ${specialMessage}
        <h3>üé≠ El/Los impostor(es): <span style="color:#ff4757;">${impostorsArr.join(', ')}</span></h3>
        <p><strong>Jugador secreto:</strong> ${gameData.theme}</p>
        <div id="resultsImage" style="margin-top:12px"></div>
      `;
      
      const img=await fetchPlayerImage(gameData.theme);
      if(img) document.getElementById('resultsImage').innerHTML=`<img src="${img}" alt="${gameData.theme}" class="player-image">`;
    }

    // ===== Navegaci√≥n =====
    function nextRound(){
      populateStartSelect();
      updateOrderPreview(gameData.startingPlayerIndex);
      showScreen('orderScreen');
    }
    
    function managePlayers(){renderPlayerInputs();showScreen('playerSetupScreen')}
    
    function hardReset(){
      gameData={
        theme:'',
        playerCount:5,
        playerNames:[],
        playerOrder:[],
        startingPlayerIndex:1,
        currentPlayer:0,
        impostorCount:1,
        impostorIndices:new Set(),
        discussionTimer:null,
        timeLeft:180,
        usedThemes:new Set(),
        consecutiveImpostorCounts:{},
        recentRounds:[],
        specialEvent: null,
        specialEventData: null,
        roundsSinceLastSpecial: 0
      };
      document.getElementById('playerCount').value='5';
      document.getElementById('playerPoolMode').value='all';
      updateImpostorOptions(5);
      updateModeInfo();
      hideSecretHints();
      toggleStealthBtn(false);
      localStorage.removeItem('impostorGameData');
      showScreen('setupScreen');
    }

    // ===== Modo secreto ultra-disimulado (toque simple) =====
    const SECRET=new Set(['feli','felipe']);
    const hintsCache=new Map();
    const stealthBtn=document.getElementById('stealthBtn');
    function norm(s){return (s||'').toLowerCase().normalize('NFD').replace(/\p{Diacritic}/gu,'').trim()}
    function isSecretUser(n){return SECRET.has(norm(n))}
    function toggleStealthBtn(show){stealthBtn.classList.toggle('hidden',!show)}

    function attachSecretMode(currentName){const enabled=isSecretUser(currentName);toggleStealthBtn(enabled);if(!enabled){hideSecretHints();return}
      // Cambiar a toque simple en lugar de mantener presionado
      const handleClick = async() => {await showSecretHintsFor(gameData.theme);installOutsideClickToHide()};
      // Limpiar listeners previos
      stealthBtn.onclick = null;
      stealthBtn.ontouchstart = null;
      stealthBtn.onmousedown = null;
      // Instalar nuevo listener de toque simple
      stealthBtn.onclick = handleClick;
      stealthBtn.ontouchstart = (e) => {e.preventDefault(); handleClick()};
      document.getElementById('hideHintsBtn').onclick=hideSecretHints
    }

    let outsideBound=false;function installOutsideClickToHide(){if(outsideBound)return;const h=e=>{const box=document.getElementById('secretHints');if(!box||box.getAttribute('aria-hidden')==='true')return;if(box.contains(e.target)||stealthBtn.contains(e.target))return;hideSecretHints()};document.addEventListener('mousedown',h,true);document.addEventListener('touchstart',h,true);outsideBound=true}

    function hideSecretHints(){const box=document.getElementById('secretHints');box.classList.remove('visible');box.setAttribute('aria-hidden','true')}

    async function showSecretHintsFor(name){const title=document.getElementById('secretTitle');const pos=document.getElementById('hintPosition');const nat=document.getElementById('hintNation');const st=document.getElementById('hintStatus');const tm=document.getElementById('hintTeams');const tt=document.getElementById('hintTitles');const box=document.getElementById('secretHints');title.textContent=`üîç Pistas de ${name}:`;[pos,nat,st,tm,tt].forEach(e=>e.textContent='Cargando‚Ä¶');box.classList.add('visible');box.setAttribute('aria-hidden','false');try{const h=await getHints(name);pos.textContent=h.position||'‚Äî';nat.textContent=h.nationality||'‚Äî';st.textContent=h.status||'‚Äî';tm.textContent=h.teams?.length?h.teams.join(', '):'‚Äî';tt.textContent=h.titles?.length?h.titles.join(' ¬∑ '):'‚Äî'}catch(_){[pos,nat,st,tm,tt].forEach((e,i)=>e.textContent=i? '‚Äî':'No disponible')}}

    // ===== Hints (solo Wikipedia REST, compacto) =====
    async function getHints(player){const key=norm(player);if(hintsCache.has(key))return hintsCache.get(key);const sum=await wikiSummaryAny(player);const h=buildHints(sum);hintsCache.set(key,h);return h}
    async function wikiSummaryAny(title){for(const lang of ['en','es']){try{const r=await fetchWithTimeout(`https://${lang}.wikipedia.org/api/rest_v1/page/summary/${encodeURIComponent(title)}`,{},6000).catch(()=>null);if(r&&r.ok){const j=await r.json();if(!/may refer to/i.test(j?.title||''))return j}}catch(_){}}return null}

    function buildHints(sum){const out={position:'',nationality:'',status:'',teams:[],titles:[]};if(!sum)return out;const txt=(sum.extract||'');const desc=(sum.description||'');out.nationality=natFrom(desc)||natFrom(txt)||'';out.position=posFrom(txt)||'';out.status=/\bformer|retired\b/i.test(txt)?'Retirado':'Activo';const team=(txt.match(/for (?:the )?(?:[A-Za-z√Ä-√ø'\- ]+ club )?([A-Z][A-Za-z√Ä-√ø0-9'\.\-& ]{2,})(?:[,\.\n]| who| and| of| in )/)||[])[1];if(team)out.teams=[team];const K=['world cup','champions league','ballon','copa am√©rica','copa del mundo','libertadores','premier league','la liga','serie a','bundesliga','copa del rey','euros'];const low=txt.toLowerCase();out.titles=K.filter(k=>low.includes(k)).slice(0,4).map(cap);return out}
    function cap(s){return s.charAt(0).toUpperCase()+s.slice(1)}
    function natFrom(s){const m=(s||'').match(/\b(english|british|spanish|argentine|argentinian|portuguese|brazilian|french|german|italian|belgian|dutch|uruguayan|chilean|mexican|colombian|peruvian|ecuadorian)\b/i);const map={english:'Inglaterra',british:'Reino Unido',spanish:'Espa√±a',argentine:'Argentina',argentinian:'Argentina',portuguese:'Portugal',brazilian:'Brasil',french:'Francia',german:'Alemania',italian:'Italia',belgian:'B√©lgica',dutch:'Pa√≠ses Bajos',uruguayan:'Uruguay',chilean:'Chile',mexican:'M√©xico',colombian:'Colombia',peruvian:'Per√∫',ecuadorian:'Ecuador'};return m?map[m[1].toLowerCase()]||'':''}
    function posFrom(s){const r=(s||'').match(/play(?:s|ed) as an? ([a-z \-]+?)(?: for|\.|,)/i);const raw=r?r[1].toLowerCase():'';const dict=[['goalkeeper','Portero'],['striker','Delantero'],['forward','Delantero'],['winger','Extremo'],['midfielder','Mediocampista'],['attacking midfielder','Mediapunta'],['defensive midfielder','Mediocentro defensivo'],['defender','Defensor'],['centre-back','Defensor central'],['left-back','Lateral izquierdo'],['right-back','Lateral derecho'],['wing-back','Carrilero']];for(const [en,es] of dict){if(raw.includes(en))return es}return''}

    // ===== Init =====
    (function init(){
      // Load saved data first
      loadGameData();
      // set initial impostor options based on initial player count
      updateImpostorOptions(gameData.playerCount);
      // update mode info
      updateModeInfo();
      // attach onchange for playerCount (in case user changes it directly)
      document.getElementById('playerCount').addEventListener('change', onPlayerCountChange);
      document.getElementById('impostorCount').addEventListener('change', () => {
        gameData.impostorCount = parseInt(document.getElementById('impostorCount').value);
        saveGameData();
      });
    })();
  </script>
</body>
</html>
