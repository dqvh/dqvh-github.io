<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Impostor ‚Äî F√∫tbol</title>
  <style>
    :root{
      --bg1:#0f172a;
      --accent:#6c5ce7;
      --card:#ffffff;
      --muted:#6b7280;
      --success:#16a34a;
      --danger:#ef4444;
      --glass: rgba(255,255,255,0.06);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:Inter,system-ui,Segoe UI,Arial,sans-serif;
      background:
        radial-gradient(800px 400px at 10% 10%, rgba(108,92,231,0.12), transparent 10%),
        linear-gradient(180deg,#071029 0%, #0b1220 100%);
      color:#0b1220;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:24px;
    }

    .app {
      width:100%;
      max-width:720px;
      background:linear-gradient(180deg, rgba(255,255,255,0.98), rgba(255,255,255,0.96));
      border-radius:14px;
      padding:20px;
      box-shadow: 0 20px 50px rgba(2,6,23,0.5);
      overflow:hidden;
    }

    header{
      display:flex;
      align-items:center;
      gap:12px;
      margin-bottom:8px;
    }
    .logo{
      width:44px;height:44px;border-radius:10px;
      background:linear-gradient(135deg,var(--accent),#a78bfa);
      display:flex;align-items:center;justify-content:center;color:white;font-weight:700;font-size:20px;
      box-shadow:0 6px 18px rgba(108,92,231,0.18);
    }
    h1{font-size:18px;margin:0;color:#0f172a}
    p.lead{margin:6px 0 14px;color:var(--muted);font-size:13px}

    /* layout */
    .row{display:flex;gap:12px}
    .col{flex:1}

    /* compact controls */
    select,input{width:100%;padding:10px;border-radius:10px;border:1px solid #e6e9ef;font-size:14px;background:white}
    input::placeholder{color:#c7cbd6}

    .btn{
      display:inline-flex;align-items:center;justify-content:center;gap:8px;
      background:var(--accent);color:white;border:none;padding:10px 14px;border-radius:10px;font-weight:600;cursor:pointer;
      box-shadow:0 8px 18px rgba(108,92,231,0.12);
    }
    .btn.ghost{background:transparent;color:var(--muted);border:1px solid #eef1f6}
    .btn.warn{background:#f59e0b}
    .btn.flat{background:var(--card);color:var(--muted);border:1px solid #eef1f6;box-shadow:none}

    .center{display:flex;justify-content:center;align-items:center}

    /* screens */
    .screen{display:none;padding-top:6px}
    .screen.active{display:block}

    /* player list */
    .players{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    .player-input{display:flex;gap:8px}
    .player-input input{flex:1}

    /* order preview */
    .order-preview{background:var(--glass);padding:12px;border-radius:10px;color:var(--muted);font-size:14px}

    /* transfer */
    .big-emoji{font-size:72px;margin:12px 0}

    /* role card */
    .role-card{border-radius:12px;padding:18px;background:#f8fafc;display:flex;flex-direction:column;gap:8px;align-items:center;min-height:160px;justify-content:center}
    .role-card.reveal{transform:translateY(-6px);box-shadow:0 18px 30px rgba(2,6,23,0.08)}
    .role-title{font-weight:700;font-size:18px}
    .role-sub{font-size:13px;color:var(--muted)}

    .impostor-card{background:linear-gradient(135deg,#ff7b7b,#ff5245);color:white}
    .innocent-card{background:linear-gradient(135deg,#7ee787,#3fcf73);color:white}

    .player-image{max-width:64%;border-radius:8px;margin-top:8px;box-shadow:0 8px 16px rgba(2,6,23,0.08)}

    /* secret panel ‚Äî compact */
    .secret-hints{
      position:absolute;left:50%;transform:translateX(-50%);bottom:22px;width:calc(100% - 48px);max-width:640px;
      background:#0b1220;color:white;padding:12px 14px;border-radius:12px;box-shadow:0 20px 40px rgba(2,6,23,0.6);
      font-size:13px;display:none;
    }
    .secret-hints.visible{display:block}
    .secret-row{display:flex;gap:10px;align-items:center;margin:6px 0}
    .hint-key{width:100px;color:#93c5fd;font-weight:600}
    .hint-val{flex:1;color:#dbeafe;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

    footer{display:flex;gap:8px;align-items:center;justify-content:space-between;margin-top:12px}
    .small{font-size:12px;color:var(--muted)}
    /* responsive */
    @media (max-width:520px){
      .players{grid-template-columns:1fr}
      .player-image{max-width:92%}
    }
  </style>
</head>
<body>
  <div class="app" role="application" aria-label="Juego del Impostor - F√∫tbol">
    <header>
      <div class="logo">IF</div>
      <div>
        <h1>Impostor ‚Äî F√∫tbol</h1>
        <p class="lead">Ronda r√°pida: uno es impostor, los dem√°s conocen al jugador secreto.</p>
      </div>
    </header>

    <!-- SETUP -->
    <section id="setup" class="screen active">
      <div class="row">
        <div class="col">
          <label class="small">Jugadores</label>
          <select id="playerCount">
            <option value="3">3</option><option value="4">4</option><option value="5" selected>5</option>
            <option value="6">6</option><option value="7">7</option><option value="8">8</option>
            <option value="9">9</option><option value="10">10</option>
          </select>
        </div>
        <div style="width:140px" class="center">
          <button class="btn" onclick="setupPlayers()">Configurar</button>
        </div>
      </div>
    </section>

    <!-- PLAYERS -->
    <section id="playerSetup" class="screen">
      <div class="row" style="align-items:center;margin-bottom:8px">
        <strong>Jugadores</strong>
        <div style="margin-left:auto;display:flex;gap:8px">
          <button class="btn flat" style="padding:8px 10px" onclick="removePlayerInput()">‚àí</button>
          <div class="small center" id="countLabel"></div>
          <button class="btn flat" style="padding:8px 10px" onclick="addPlayerInput()">+</button>
        </div>
      </div>
      <div id="playerNamesContainer" class="players" style="margin-bottom:12px"></div>

      <div class="row">
        <div class="col">
          <button class="btn" onclick="continueToOrderSelection()">Siguiente</button>
        </div>
        <div style="width:120px">
          <button class="btn ghost" onclick="goHome()">Volver</button>
        </div>
      </div>
    </section>

    <!-- ORDER -->
    <section id="order" class="screen">
      <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px">
        <strong>Qui√©n empieza</strong>
        <select id="startPlayerSelect" style="margin-left:8px"></select>
        <div style="margin-left:auto;display:flex;gap:8px">
          <button class="btn flat" onclick="shuffleOrder()">Aleatorio</button>
          <button class="btn" onclick="startRoundFromOrder()">Iniciar</button>
        </div>
      </div>

      <div class="order-preview">
        <strong style="display:block;margin-bottom:6px">Orden</strong>
        <ol id="orderPreviewList" style="margin:0;padding-left:18px;color:var(--muted)"></ol>
      </div>
    </section>

    <!-- TRANSFER -->
    <section id="transfer" class="screen center" style="flex-direction:column">
      <div class="big-emoji">ü§´</div>
      <div style="font-weight:700;margin-bottom:6px" id="nextPlayerName">Jugador X</div>
      <div class="small" style="margin-bottom:12px" id="receivingPlayer">Toma el tel√©fono y presiona</div>
      <div style="width:100%;max-width:320px">
        <button class="btn" onclick="showPlayerRole()">Ver mi rol</button>
      </div>
    </section>

    <!-- GAME ROLE -->
    <section id="game" class="screen">
      <div style="display:flex;align-items:center;justify-content:space-between">
        <div>
          <div class="small">Turno de</div>
          <div class="role-title" id="playerTitle">Jugador 1</div>
        </div>
        <div style="text-align:right">
          <button id="finishButton" class="btn flat" onclick="finishPlayerTurn()">Listo</button>
        </div>
      </div>

      <div id="roleCard" class="role-card" style="margin-top:12px">
        <div id="roleText" class="role-title">‚Äî</div>
        <div id="themeText" class="role-sub">‚Äî</div>
        <div id="themeImage"></div>
      </div>

      <div style="margin-top:10px;display:flex;gap:8px;justify-content:center">
        <button class="btn ghost" onclick="hideSecretHints()" style="padding:8px 10px">Ocultar pistas</button>
      </div>

      <!-- secret hints -->
      <div id="secretHints" class="secret-hints" role="region" aria-hidden="true">
        <div id="secretTitle" style="font-weight:700;margin-bottom:6px">Pistas</div>
        <div class="secret-row"><div class="hint-key">Posici√≥n</div><div id="hintPosition" class="hint-val">‚Äî</div></div>
        <div class="secret-row"><div class="hint-key">Pa√≠s</div><div id="hintNation" class="hint-val">‚Äî</div></div>
        <div class="secret-row"><div class="hint-key">Estado</div><div id="hintStatus" class="hint-val">‚Äî</div></div>
        <div class="secret-row"><div class="hint-key">Equipos</div><div id="hintTeams" class="hint-val">‚Äî</div></div>
        <div class="secret-row"><div class="hint-key">T√≠tulos</div><div id="hintTitles" class="hint-val">‚Äî</div></div>
        <div style="text-align:right;margin-top:8px"><button class="btn ghost" id="hideHintsBtn" onclick="hideSecretHints()">Cerrar</button></div>
      </div>
    </section>

    <!-- DISCUSSION -->
    <section id="discussion" class="screen center" style="flex-direction:column">
      <div class="role-title" style="font-size:20px">Discusi√≥n</div>
      <div id="discussionTimer" class="role-sub" style="font-size:20px;margin:10px 0;color:var(--muted)">3:00</div>
      <div class="small" style="margin-bottom:12px;color:var(--muted)">Hablen 2‚Äì3 minutos. Luego revelen.</div>
      <div style="width:220px">
        <button class="btn warn" onclick="showResults()">Revelar</button>
      </div>
    </section>

    <!-- RESULTS -->
    <section id="results" class="screen">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div>
          <div style="font-weight:700">Resultados</div>
          <div class="small" id="resultsSub">‚Äî</div>
        </div>
        <div style="display:flex;gap:8px">
          <button class="btn" onclick="nextRound()">Nueva ronda</button>
          <button class="btn ghost" onclick="managePlayers()">Editar</button>
        </div>
      </div>
      <div id="resultsContent" style="margin-top:12px"></div>
      <div style="margin-top:12px"><button class="btn flat" onclick="hardReset()">Reiniciar</button></div>
    </section>

    <footer>
      <div class="small">Tap triple en la tarjeta si sos Feli/Felipe ‚Üí pistas</div>
      <div class="small">dqvh ‚Ä¢ 2025</div>
    </footer>
  </div>

  <script>
    // ========= state =========
    let gameData = {
      theme: '',
      playerCount: 5,
      playerNames: [],
      playerOrder: [],
      startingPlayerIndex: 1,
      currentPlayer: 0,
      impostorIndex: -1,
      discussionTimer: null,
      timeLeft: 180,
      usedThemes: new Set()
    };

    // screens
    const screens = {
      setup: document.getElementById('setup'),
      playerSetup: document.getElementById('playerSetup'),
      order: document.getElementById('order'),
      transfer: document.getElementById('transfer'),
      game: document.getElementById('game'),
      discussion: document.getElementById('discussion'),
      results: document.getElementById('results')
    };
    function showScreen(k){
      Object.values(screens).forEach(el => el.classList.remove('active'));
      screens[k].classList.add('active');
      // hide secret panel except when in game screen
      if (k !== 'game') hideSecretHints();
    }

    function goHome(){ showScreen('setup'); }

    // ========= players list =========
    const famousPlayers = [ "Pel√©","Diego Maradona","Johan Cruyff","Franz Beckenbauer","Alfredo Di St√©fano","Ferenc Pusk√°s","Eus√©bio","Lev Yashin","George Best","Bobby Charlton","Garrincha","Just Fontaine","Gerd M√ºller","Bobby Moore","Gordon Banks","Marco van Basten","Michel Platini","Roberto Baggio","Lothar Matth√§us","Franco Baresi","Paolo Maldini","Ruud Gullit","Frank Rijkaard","Ronald Koeman","Hristo Stoichkov","Rom√°rio","Bebeto","Claudio Caniggia","Gabriel Batistuta","Salvatore Schillaci","Ronaldo Naz√°rio","Ronaldinho","Kak√°","Zinedine Zidane","Luis Figo","Thierry Henry","Ra√∫l Gonz√°lez","Francesco Totti","Alessandro Del Piero","Gianluigi Buffon","Iker Casillas","Oliver Kahn","Michael Ballack","Pavel Nedvƒõd","Andr√©s Iniesta","Xavi Hern√°ndez","Carles Puyol","Gerard Piqu√©","David Beckham","Steven Gerrard","Frank Lampard","Paul Scholes","Ryan Giggs","Roy Keane","Patrick Vieira","Claude Mak√©l√©l√©","Fabio Cannavaro","Alessandro Nesta","Jaap Stam","Rio Ferdinand","John Terry","Ashley Cole","Cafu","Roberto Carlos","Javier Zanetti","Lionel Messi","Cristiano Ronaldo","Neymar","Kylian Mbapp√©","Erling Haaland","Robert Lewandowski","Kevin De Bruyne","Mohamed Salah","Sadio Man√©","Riyad Mahrez","Raheem Sterling","Harry Kane","Son Heung-min","Bruno Fernandes","Paul Pogba","N'Golo Kant√©","Virgil van Dijk","Sergio Ramos","Rapha√´l Varane","Karim Benzema","Luka Modriƒá","Toni Kroos","Casemiro","Sergio Busquets","Pedri","Gavi","Frenkie de Jong","Ansu Fati","Ferran Torres","Dani Olmo","Vin√≠cius J√∫nior","Jude Bellingham","Eduardo Camavinga","Aur√©lien Tchouam√©ni","Enzo Fern√°ndez","Jamal Musiala","Florian Wirtz","Bukayo Saka","Phil Foden","Mason Mount","Declan Rice","Martin √òdegaard","Alexander Isak","Darwin N√∫√±ez","Luis D√≠az","Diogo Jota","Cody Gakpo","Antony","Marcus Rashford","Jadon Sancho","Jack Grealish","R√∫ben Dias","Josko Gvardiol","William Saliba","Gabriel Martinelli","Lamine Yamal","Alejandro Balde","Ronald Ara√∫jo","Jules Kound√©","Ousmane Demb√©l√©","Raphinha","Lautaro Mart√≠nez","Nico Gonz√°lez","Juli√°n √Ålvarez","√Ångel Di Mar√≠a","Paulo Dybala","Leandro Paredes","Rodrigo De Paul","Manuel Neuer","Alisson Becker","Ederson","Jan Oblak","Thibaut Courtois","Hugo Lloris","Keylor Navas","Gianluigi Donnarumma","Yann Sommer","Emiliano Mart√≠nez","Marc-Andr√© ter Stegen","Claudio Bravo","David de Gea","Jordan Pickford","Aaron Ramsdale","Dani Alves","Marcelo","Jordi Alba","Andrew Robertson","Trent Alexander-Arnold","Kyle Walker","Jo√£o Cancelo","Achraf Hakimi","Theo Hern√°ndez","Lucas Hern√°ndez","Dayot Upamecano","Ibrahima Konat√©","Eder Milit√£o","Antonio R√ºdiger","Thiago Silva","Marquinhos","Presnel Kimpembe","Milan ≈†kriniar","Alessandro Bastoni","Federico Dimarco","Giorgio Chiellini","Leonardo Bonucci","Francesco Acerbi","Kalidou Koulibaly","Aymeric Laporte","Pau Torres","Diego Carlos","Jos√© Gim√©nez","Diego God√≠n","Stefan Saviƒá","Joshua Kimmich","Leon Goretzka","Ilkay G√ºndogan","Thomas M√ºller","Marco Reus","Marco Verratti","Nicolo Barella","Lorenzo Pellegrini","Ciro Immobile","Federico Chiesa","Lorenzo Insigne","Domenico Berardi","Matteo Politano","Khvicha Kvaratskhelia","Victor Osimhen","Piotr Zielinski","Fabi√°n Ruiz","Carlos Soler","Mikel Oyarzabal","Isco","Marco Asensio","Brahim D√≠az","Federico Valverde","Rodrygo","Endrick","Sergio Ag√ºero","Fernando Torres","David Villa","√Ålvaro Morata","Gerard Moreno","Dani Carvajal","Nacho Fern√°ndez","Jes√∫s Navas","Marcos Llorente","Koke","Sa√∫l √ë√≠guez","Jo√£o F√©lix","Antoine Griezmann","Memphis Depay","Sergi Roberto","Ferm√≠n L√≥pez","Pau Cubars√≠","H√©ctor Fort","Marc Guiu","Vitor Roque","Romelu Lukaku","Eden Hazard","Yannick Carrasco","Jeremy Doku","Charles De Ketelaere","Amadou Onana","Arthur Theate","Wout Faes","Matthijs de Ligt","Denzel Dumfries","Steven Bergwijn","Wout Weghorst","Daley Blind","Stefan de Vrij","Wojciech Szczƒôsny","Jan Bednarek","Matty Cash","Krzysztof PiƒÖtek","Arkadiusz Milik","Kamil Glik","Grzegorz Krychowiak","Jakub Moder","Riyad Mahrez","Bernardo Silva","Rodri","John Stones","Diogo Dalot","Harry Maguire","Alexis Mac Allister","Ryan Gravenberch","Wataru Endo","James Maddison","Dejan Kulusevski","Brennan Johnson","Pape Matar Sarr","Yves Bissouma","Pedro Porro","Cristian Romero","Micky van de Ven","Destiny Udogie","Warren Za√Øre-Emery","Bradley Barcola","Randal Kolo Muani","Vitinha","Jo√£o Neves","Nuno Mendes","Arda G√ºler","Kenan Yildiz","Francisco Concei√ß√£o","Samu Omorodion","Pau Prim","Dani Rodriguez","Takefusa Kubo","Kang-in Lee","Hwang Hee-chan" ];

    // ======= flow helpers =======
    function setupPlayers(){
      gameData.playerCount = parseInt(document.getElementById('playerCount').value,10) || 5;
      gameData.playerNames = new Array(gameData.playerCount + 1);
      renderPlayerInputs();
      showScreen('playerSetup');
    }

    function renderPlayerInputs(){
      const container = document.getElementById('playerNamesContainer');
      container.innerHTML = '';
      for (let i=1;i<=gameData.playerCount;i++){
        const wrap = document.createElement('div');
        wrap.className = 'player-input';
        const input = document.createElement('input');
        input.type = 'text';
        input.id = `playerName${i}`;
        input.placeholder = `Jugador ${i}`;
        if (gameData.playerNames[i]) input.value = gameData.playerNames[i];
        wrap.appendChild(input);
        container.appendChild(wrap);
      }
      document.getElementById('countLabel').textContent = `${gameData.playerCount} jugadores`;
    }

    function addPlayerInput(){ if (gameData.playerCount>=10) return; gameData.playerCount++; renderPlayerInputs(); }
    function removePlayerInput(){ if (gameData.playerCount<=3) return; gameData.playerCount--; gameData.playerNames.length = gameData.playerCount+1; renderPlayerInputs(); }

    function continueToOrderSelection(){
      for (let i=1;i<=gameData.playerCount;i++){
        const val = (document.getElementById(`playerName${i}`)?.value || '').trim();
        gameData.playerNames[i] = val || `Jugador ${i}`;
      }
      buildDefaultOrder();
      populateStartSelect();
      updateOrderPreview(gameData.startingPlayerIndex);
      showScreen('order');
    }

    function buildDefaultOrder(){
      gameData.playerOrder = Array.from({length:gameData.playerCount},(_,i)=>i+1);
    }

    function rotateOrderStartingAt(startAbsIndex){
      const order = Array.from({length:gameData.playerCount},(_,i)=>i+1);
      const pos = order.indexOf(startAbsIndex);
      if (pos<0) return order;
      return order.slice(pos).concat(order.slice(0,pos));
    }

    function populateStartSelect(){
      const sel = document.getElementById('startPlayerSelect');
      sel.innerHTML = '';
      for (let i=1;i<=gameData.playerCount;i++){
        const opt = document.createElement('option');
        opt.value = String(i);
        opt.textContent = gameData.playerNames[i];
        sel.appendChild(opt);
      }
      sel.onchange = ()=> updateOrderPreview(parseInt(sel.value,10));
      sel.value = String(gameData.startingPlayerIndex || 1);
    }

    function updateOrderPreview(startAbsIndex){
      gameData.startingPlayerIndex = startAbsIndex;
      const order = rotateOrderStartingAt(startAbsIndex);
      const list = document.getElementById('orderPreviewList');
      list.innerHTML = '';
      order.forEach(idx=>{
        const li = document.createElement('li');
        li.textContent = gameData.playerNames[idx];
        list.appendChild(li);
      });
    }

    function shuffleOrder(){
      const arr = Array.from({length:gameData.playerCount},(_,i)=>i+1);
      for(let i=arr.length-1;i>0;i--){ const j = Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]]; }
      gameData.playerOrder = arr.slice();
      gameData.startingPlayerIndex = arr[0];
      populateStartSelect();
      updateOrderPreview(gameData.startingPlayerIndex);
    }

    function startRoundFromOrder(){
      gameData.playerOrder = rotateOrderStartingAt(gameData.startingPlayerIndex);
      prepareRound();
    }

    function prepareRound(){
      gameData.currentPlayer = 0;
      pickNewThemeNoRepeat();
      gameData.impostorIndex = Math.floor(Math.random()*gameData.playerCount) + 1;
      showTransferScreenForRole();
    }

    function pickNewThemeNoRepeat(){
      let candidates = famousPlayers.filter(p => !gameData.usedThemes.has(p));
      if (!candidates.length){ gameData.usedThemes.clear(); candidates = famousPlayers.slice(); }
      const choice = candidates[Math.floor(Math.random()*candidates.length)];
      gameData.theme = choice;
      gameData.usedThemes.add(choice);
    }

    function showTransferScreenForRole(){
      if (gameData.currentPlayer < gameData.playerCount){
        const nextAbs = gameData.playerOrder[gameData.currentPlayer];
        document.getElementById('nextPlayerName').textContent = gameData.playerNames[nextAbs];
        document.getElementById('receivingPlayer').textContent = '';
        showScreen('transfer');
      } else {
        startDiscussion();
      }
    }

    function showPlayerRole(){
      gameData.currentPlayer++;
      showScreen('game');
      updatePlayerScreen();
    }

    // fetch timeout helper
    async function fetchWithTimeout(url, opts={}, ms=7000){
      const ctl = new AbortController();
      const id = setTimeout(()=>ctl.abort(), ms);
      try{
        const res = await fetch(url, {...opts, signal: ctl.signal});
        clearTimeout(id);
        return res;
      }catch(err){ clearTimeout(id); throw err; }
    }

    async function fetchPlayerImage(title){
      try{
        const url = `https://en.wikipedia.org/w/api.php?action=query&prop=pageimages&format=json&pithumbsize=300&titles=${encodeURIComponent(title)}&origin=*`;
        const resp = await fetchWithTimeout(url, {}, 6000).catch(()=>null);
        if (!resp || !resp.ok) return '';
        const data = await resp.json();
        const pages = data.query?.pages || {};
        const id = Object.keys(pages)[0];
        return pages[id]?.thumbnail?.source || '';
      }catch(err){ console.warn('image fetch',err); return ''; }
    }

    async function updatePlayerScreen(){
      const playerTitle = document.getElementById('playerTitle');
      const roleCard = document.getElementById('roleCard');
      const roleText = document.getElementById('roleText');
      const themeText = document.getElementById('themeText');
      const themeImage = document.getElementById('themeImage');
      const finishButton = document.getElementById('finishButton');

      const absIndex = gameData.playerOrder[gameData.currentPlayer - 1];
      const currentName = gameData.playerNames[absIndex];
      playerTitle.textContent = currentName;
      themeImage.innerHTML = '';

      if (absIndex === gameData.impostorIndex){
        roleCard.className = 'role-card impostor-card reveal';
        roleText.textContent = 'ERES EL IMPOSTOR';
        themeText.textContent = 'Intent√° pasar desapercibido';
      } else {
        roleCard.className = 'role-card innocent-card reveal';
        roleText.textContent = 'SOS INOCENTE';
        themeText.textContent = gameData.theme;
        try{
          const img = await fetchPlayerImage(gameData.theme);
          if (img) themeImage.innerHTML = `<img src="${img}" alt="${gameData.theme}" class="player-image">`;
        }catch(e){ /* ignore */ }
      }

      finishButton.textContent = (gameData.currentPlayer === gameData.playerCount) ? 'Iniciar discusi√≥n' : 'Listo';
      attachSecretModeIfNeeded(currentName);
    }

    function finishPlayerTurn(){
      const rc = document.getElementById('roleCard');
      rc.classList.remove('reveal');
      hideSecretHints();
      showTransferScreenForRole();
    }

    // discussion timer
    function startDiscussion(){
      showScreen('discussion');
      startTimer();
    }
    function startTimer(){
      gameData.timeLeft = 180;
      const el = document.getElementById('discussionTimer');
      clearInterval(gameData.discussionTimer);
      gameData.discussionTimer = setInterval(()=>{
        const m = Math.floor(gameData.timeLeft/60);
        const s = gameData.timeLeft%60;
        el.textContent = `${m}:${String(s).padStart(2,'0')}`;
        if (gameData.timeLeft<=0){
          clearInterval(gameData.discussionTimer);
          el.textContent = '0:00';
          showResults();
        }
        gameData.timeLeft--;
      },1000);
    }

    async function showResults(){
      clearInterval(gameData.discussionTimer);
      showScreen('results');
      const resultsContent = document.getElementById('resultsContent');
      const sub = document.getElementById('resultsSub');
      sub.textContent = `${gameData.playerNames[gameData.impostorIndex]} era el impostor`;
      resultsContent.innerHTML = `<div style="font-weight:700;margin-top:8px">${gameData.theme}</div><div id="resultsImage" style="margin-top:8px"></div>`;
      try{
        const img = await fetchPlayerImage(gameData.theme);
        if (img) document.getElementById('resultsImage').innerHTML = `<img src="${img}" alt="${gameData.theme}" class="player-image">`;
      }catch(e){ /* ignore */ }
    }

    function nextRound(){
      populateStartSelect();
      updateOrderPreview(gameData.startingPlayerIndex);
      showScreen('order');
    }

    function managePlayers(){
      renderPlayerInputs();
      showScreen('playerSetup');
    }

    function hardReset(){
      gameData = { theme:'', playerCount:5, playerNames:[], playerOrder:[], startingPlayerIndex:1, currentPlayer:0, impostorIndex:-1, discussionTimer:null, timeLeft:180, usedThemes:new Set() };
      document.getElementById('playerCount').value = '5';
      hideSecretHints();
      showScreen('setup');
    }

    // ========== SECRET MODE ==========
    const SECRET_NAMES = new Set(['feli','felipe']);
    const hintsCache = new Map();

    function normalizeName(s){
      return (s||'').toLowerCase().normalize('NFD').replace(/\p{Diacritic}/gu,'').trim();
    }
    function isSecretUser(name){ return SECRET_NAMES.has(normalizeName(name)); }

    function attachSecretModeIfNeeded(currentName){
      const roleCard = document.getElementById('roleCard');

      // remove previous handlers
      if (roleCard._secretHandler){
        roleCard.removeEventListener('click', roleCard._secretHandler);
        roleCard.removeEventListener('touchstart', roleCard._secretHandler);
        roleCard._secretHandler = null;
      }

      if (!isSecretUser(currentName)) return;

      // triple-tap implementation (robust for touch + click)
      let taps = 0, timer = null;
      const handler = async (ev) => {
        try{ ev.preventDefault && ev.preventDefault(); }catch(e){}
        taps++;
        if (timer) { clearTimeout(timer); timer = null; }
        if (taps >= 3){
          taps = 0;
          try{ await showSecretHintsFor(gameData.theme); } catch(err){ console.error(err); }
        } else {
          timer = setTimeout(()=>{ taps = 0; timer = null; }, 1100);
        }
      };
      roleCard._secretHandler = handler;
      roleCard.addEventListener('click', handler, {passive:false});
      roleCard.addEventListener('touchstart', handler, {passive:false});
      document.getElementById('hideHintsBtn').onclick = hideSecretHints;
    }

    function hideSecretHints(){
      const box = document.getElementById('secretHints');
      if (!box) return;
      box.classList.remove('visible');
      box.setAttribute('aria-hidden','true');
    }

    async function showSecretHintsFor(playerName){
      const titleEl = document.getElementById('secretTitle');
      const posEl = document.getElementById('hintPosition');
      const natEl = document.getElementById('hintNation');
      const stEl  = document.getElementById('hintStatus');
      const tmEl  = document.getElementById('hintTeams');
      const titlesEl = document.getElementById('hintTitles');
      const box = document.getElementById('secretHints');

      titleEl.textContent = `Pistas ‚Äî ${playerName}`;
      posEl.textContent = 'cargando‚Ä¶';
      natEl.textContent = 'cargando‚Ä¶';
      stEl.textContent = 'cargando‚Ä¶';
      tmEl.textContent = 'cargando‚Ä¶';
      titlesEl.textContent = 'cargando‚Ä¶';
      box.classList.add('visible');
      box.setAttribute('aria-hidden','false');

      try{
        const hints = await getHints(playerName);
        posEl.textContent = hints.position || '‚Äî';
        natEl.textContent = hints.nationality || '‚Äî';
        stEl.textContent  = hints.status || '‚Äî';
        tmEl.textContent  = (hints.teams && hints.teams.length) ? hints.teams.join(', ') : '‚Äî';
        titlesEl.textContent = (hints.titles && hints.titles.length) ? hints.titles.join(' ¬∑ ') : '‚Äî';
      }catch(err){
        posEl.textContent = '‚Äî';
        natEl.textContent = '‚Äî';
        stEl.textContent = '‚Äî';
        tmEl.textContent = '‚Äî';
        titlesEl.textContent = '‚Äî';
        console.error('showSecretHintsFor error',err);
      }
    }

    // ========== WIKIPEDIA / WIKIDATA HINTS ==========
    async function getHints(playerName){
      const key = normalizeName(playerName);
      if (hintsCache.has(key)) return hintsCache.get(key);

      const summary = await fetchWikiSummaryAny(playerName);
      const qid = await getWikidataIdFromAny(playerName, summary?.title);
      let wd = null;
      if (qid){
        try{ wd = await fetchWikidataEntity(qid); } catch(err){ console.warn('Wikidata failed',err); wd = null; }
      }
      const hints = buildHintsFromSources(playerName, summary, wd);
      hintsCache.set(key, hints);
      return hints;
    }

    // summary (en -> es)
    async function fetchWikiSummaryAny(title){
      let s = await fetchWikiSummary(title,'en');
      if (!s) s = await fetchWikiSummary(title,'es');
      return s;
    }

    async function fetchWikiSummary(title, lang){
      try{
        const direct = await fetchWithTimeout(`https://${lang}.wikipedia.org/api/rest_v1/page/summary/${encodeURIComponent(title)}`, {}, 6000).catch(()=>null);
        if (direct && direct.ok){
          const data = await direct.json();
          if (!data.title?.includes('may refer to')) return data;
        }
        // search fallback
        const sr = await fetchWithTimeout(`https://${lang}.wikipedia.org/w/api.php?action=query&list=search&srsearch=${encodeURIComponent(title)}&format=json&origin=*`, {}, 6000).catch(()=>null);
        if (!sr || !sr.ok) return null;
        const srj = await sr.json();
        const best = srj?.query?.search?.[0]?.title;
        if (!best) return null;
        const bestResp = await fetchWithTimeout(`https://${lang}.wikipedia.org/api/rest_v1/page/summary/${encodeURIComponent(best)}`, {}, 6000).catch(()=>null);
        if (!bestResp || !bestResp.ok) return null;
        return await bestResp.json();
      }catch(err){ console.warn('fetchWikiSummary error',err); return null; }
    }

    async function getWikidataIdFromAny(title, resolvedTitle){
      const fromEn = await getWikidataIdFromWikiTitle(resolvedTitle || title, 'en');
      if (fromEn) return fromEn;
      return await getWikidataIdFromWikiTitle(resolvedTitle || title, 'es');
    }

    async function getWikidataIdFromWikiTitle(title, lang){
      try{
        const url = `https://${lang}.wikipedia.org/w/api.php?action=query&titles=${encodeURIComponent(title)}&prop=pageprops&format=json&origin=*`;
        const resp = await fetchWithTimeout(url, {}, 6000).catch(()=>null);
        if (!resp || !resp.ok) return null;
        const data = await resp.json();
        const pages = data?.query?.pages || {};
        const pid = Object.keys(pages)[0];
        return pages[pid]?.pageprops?.wikibase_item || null;
      }catch(err){ console.warn('getWikidataId error',err); return null; }
    }

    async function fetchWikidataEntity(qid){
      try{
        const base = `https://www.wikidata.org/w/api.php?action=wbgetentities&format=json&origin=*`;
        const resp = await fetchWithTimeout(`${base}&ids=${qid}&props=claims|labels&languages=es|en`, {}, 7000).catch(()=>null);
        if (!resp || !resp.ok) return null;
        const j = await resp.json();
        const entity = j?.entities?.[qid];
        if (!entity) return null;

        const claims = entity.claims || {};
        const refIds = new Set();
        const takeIds = (p) => (claims[p]||[]).forEach(st=>{
          const dv = st?.mainsnak?.datavalue?.value;
          const id = dv?.id || (Array.isArray(dv) ? dv[0]?.id : null);
          if (id) refIds.add(id);
        });
        takeIds('P413'); // position
        takeIds('P27');  // country
        (claims['P54']||[]).forEach(st => { const id = st?.mainsnak?.datavalue?.value?.id; if (id) refIds.add(id); });
        takeIds('P166'); // awards
        takeIds('P1346'); // winner of
        takeIds('P1344'); // participant in
        const labels = await resolveLabels(Array.from(refIds));
        return { qid, claims, labels };
      }catch(err){ console.warn('fetchWikidataEntity error',err); return null; }
    }

    async function resolveLabels(ids){
      if (!ids || !ids.length) return {};
      const chunks=[];
      for (let i=0;i<ids.length;i+=45) chunks.push(ids.slice(i,i+45));
      const out = {};
      const base = `https://www.wikidata.org/w/api.php?action=wbgetentities&format=json&origin=*&props=labels&languages=es|en`;
      for (const c of chunks){
        try{
          const resp = await fetchWithTimeout(`${base}&ids=${c.join('|')}`, {}, 7000).catch(()=>null);
          if (!resp || !resp.ok) continue;
          const j = await resp.json();
          Object.entries(j.entities || {}).forEach(([id,ent])=>{
            const lbl = ent?.labels?.es?.value || ent?.labels?.en?.value;
            if (lbl) out[id] = lbl;
          });
        }catch(err){ console.warn('resolveLabels chunk',err); }
      }
      return out;
    }

    // build hints ‚Äî now extract important titles (filtered)
    function buildHintsFromSources(playerName, summary, wd){
      let position = '';
      let nationality = '';
      let status = '';
      let teams = [];
      let titles = [];

      const KEYWORDS = ['world cup','fifa world cup','champions league','uefa champions','ballon','ballon d\'or','copa am√©rica','copa libertadores','premier league','la liga','serie a','bundesliga','fa cup','coppa italia','copa del rey','uefa european championship','euros','gold cup','olympic gold','fifa club world cup'];

      if (summary){
        const extract = (summary.extract || '').toLowerCase();
        const desc = (summary.description || '').toLowerCase();
        nationality = mapNationality(desc) || nationalityFromText(summary.extract);
        position = mapPositionFromText(summary.extract);
        status = /former|retired/i.test(summary.extract) ? 'Retirado' : 'Activo';
        const club = currentClubFromText(summary.extract);
        if (club) teams.push(capitalizePhrase(club));

        // find keyword matches and take short fragments
        const found = [];
        for (const kw of KEYWORDS){
          const idx = extract.indexOf(kw);
          if (idx >= 0){
            const frag = summary.extract.substring(Math.max(0, idx-30), Math.min(summary.extract.length, idx+60)).replace(/\s+/g,' ').trim();
            found.push(capitalizePhrase(frag));
          }
        }
        if (found.length) titles.push(...found.slice(0,3));
      }

      if (wd){
        const { claims, labels } = wd;
        // position (P413)
        if (!position){
          const p413 = claims['P413']?.[0]?.mainsnak?.datavalue?.value?.id;
          if (p413 && labels[p413]) position = mapPosition(labels[p413]);
        }
        // nationality (P27)
        if (!nationality){
          const p27 = claims['P27']?.[0]?.mainsnak?.datavalue?.value?.id;
          if (p27 && labels[p27]) nationality = labels[p27];
        }
        // teams (P54)
        const p54 = claims['P54'] || [];
        const enriched = [];
        let isActive = false;
        for (const st of p54){
          const id = st?.mainsnak?.datavalue?.value?.id;
          if (!id) continue;
          const name = labels[id];
          if (name) enriched.push(name);
          const q = st.qualifiers || {};
          if (!q['P582']) isActive = true;
        }
        teams = Array.from(new Set([...teams, ...enriched])).slice(0,5);
        if (!status) status = isActive ? 'Activo' : 'Retirado';

        // titles: P166, P1346, P1344 labels -> filter by keywords
        const cand = [];
        ['P166','P1346','P1344'].forEach(prop=>{
          (claims[prop]||[]).forEach(st=>{
            const dv = st?.mainsnak?.datavalue?.value;
            const id = dv?.id || (Array.isArray(dv) ? dv[0]?.id : null);
            if (!id) return;
            const lbl = labels[id];
            if (lbl) cand.push(lbl);
          });
        });
        // filter by keyword presence
        const filtered = cand.filter(t => {
          const low = (t||'').toLowerCase();
          return KEYWORDS.some(k => low.includes(k));
        });
        const chosen = (filtered.length ? filtered : cand).slice(0,4);
        titles = Array.from(new Set([...titles, ...chosen])).slice(0,4);
      }

      if (!position) position = '‚Äî';
      if (!nationality) nationality = '‚Äî';
      if (!status) status = '‚Äî';
      return { position, nationality, status, teams, titles };
    }

    // heuristics
    function capitalizePhrase(s){ if (!s) return s; return s.replace(/\s+/g,' ').trim().replace(/(^|\.\s+)([a-z])/g,(m,p,ch)=>p+ch.toUpperCase()); }
    function currentClubFromText(text){
      if (!text) return '';
      const m = text.match(/for (?:the )?(?:[A-Za-z√Ä-√ø'\- ]+ club )?([A-Z][A-Za-z√Ä-√ø0-9'\.\-& ]{2,})(?:[,\.\n]| who| and| of| in )/);
      return m ? m[1].trim() : '';
    }
    function nationalityFromText(text){
      if (!text) return '';
      const m = text.match(/\b([A-Z][a-z]+) professional footballer/);
      return mapNationality(m?.[1] || '');
    }
    function mapNationality(adj){
      if (!adj) return '';
      const a = (adj||'').toLowerCase();
      const map = {'english':'Inglaterra','spanish':'Espa√±a','argentine':'Argentina','brazilian':'Brasil','portuguese':'Portugal','french':'Francia','german':'Alemania','italian':'Italia','belgian':'B√©lgica','dutch':'Pa√≠ses Bajos','swiss':'Suiza','japanese':'Jap√≥n','mexican':'M√©xico','uruguayan':'Uruguay','colombian':'Colombia','chilean':'Chile','peruvian':'Per√∫','nigerian':'Nigeria','egyptian':'Egipto','senegalese':'Senegal'};
      return map[a] || '';
    }
    function mapPositionFromText(text){
      if (!text) return '';
      const m = text.match(/play(?:s|ed) as an? ([a-z \-]+?)(?: for|\.|,)/i);
      const raw = m ? m[1].trim() : '';
      return mapPosition(raw);
    }
    function mapPosition(raw){
      const r = (raw||'').toLowerCase();
      const dict = [['goalkeeper','Portero'],['striker','Delantero'],['forward','Delantero'],['winger','Extremo'],['midfielder','Mediocampista'],['defender','Defensor'],['left-back','Lateral izquierdo'],['right-back','Lateral derecho']];
      for (const [k,v] of dict) if (r.includes(k)) return v;
      if (!raw) return '';
      return raw;
    }

    // init: start on setup
    showScreen('setup');

    // expose helper for transfer screen: when it's time to reveal, receiving player should press "Ver mi rol".
    // No further automatic actions here.

    // (end)
  </script>
</body>
</html>
